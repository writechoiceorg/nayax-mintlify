---
title: "Multi-Session"
---

The Marshall Multi-session payment flow is made out of 2 separate parts: the product selection + authorization of the consumer's card, and settlement- which can happen anywhere between 1 minute and 23 hours from the initiation of the transaction. This is unlike the Single session flow, in which the settlement is done right after the product selection and authorization.

<br />

It's main features are:

This flow enables you to manage **multiple concurrent transactions** (though it can also support one transaction at a time if desired). This flow is applicable in peripherals such as EV chargers, where several consumers use the same station simultaneously but use different pumps and require independent payment processing.

<br />

In addition, this flow is **useful in cases in which the vending process is on the longer side** (longer than 4 minutes and 15 seconds)- as the Nayax Device would not expect for the transaction to be settled right after the peripheral would let it know if the product was vended and said status of vending can be changed during the settlement stage.
Meaning the peripheral can start with notifying the Nayax Device that it was able to start providing the product/service right after the card's authorization, but then if something happened (the vending ended up being unsuccessful/service stopped taking place) after that and he'd like to not charge the consumer- he can change the status at the settlement stage

<br />

Another use for Multi-session (a PreSelection flow) is that it behaves similarly to the Single session with PreAuthorization flow- as in Multisession the transaction process starts with authorization of the highest amount the peripheral would be willing to charge the consumer, and the final price at the settlement stage can be equal or lower to this price.
The reason to use Multisession over Single session with PreAuthorization (if there is no need for concurrent transactions) is that for some acquirers the fact that Multisession flow is technically a PreSelection flow would **sometimes (depending on the acquirer) allow for quicker release of the captured credit**- the credit that the consumer's card was authorized for and can take days or even weeks in some cases to be released. Meaning the final price may take quite some time to be updated on the acquirer's end and in said timeframe the consumer may think he was charged for the full authorization amount even if that wasn't the case (just takes time to be updated).

## Payment Flow

The diagrams below illustrates the sequence of events within the multi-session payment flow. Note that in this flow there are 2 parts to the transaction process- so you'd see 2 separate diagrams, one for each step:

<br />

<Image align="center" border={false} src="https://files.readme.io/e06fb63ae2f7881e5a60eb4b85e7da356c1373e32d51214679d6c7524c159ee7-4.jpg" />

<Image align="center" border={false} src="https://files.readme.io/7587b0a7fd55b38c364e20588d80fcc0d5be817881676aab11c44b3448ca5107-5.jpg" />

Below is a breakdown of the diagram:

1. The Nayax Device sends a message to the consumer: "Please Select a Product."
2. The consumer selects a product for the vending machine.
3. The peripheral's SDK sends a vending request to the Nayax Device:
   ```c
   vmc_vend_vend_request(vend_session_t *session)
   ```
   ```csharp
   vmc_instance.vend.vend_request(session);
   ```
   ```java
   m_vmc.vend.vend_request(m_sessions[m_active_session]);
   ```
4. The Nayax Device sends a message to the consumer: "Please Present Card."
5. The consumer presents their payment card.
6. The Nayax Device sends an authorization request to the Nayax Server.
7. The Nayax Server forwards the authorization request to the Billing Provider.
8. The Billing Provider sends an authorization response (approved) to the Nayax Server.
9. The Nayax Server sends the authorization response (approved) back to the Nayax Device.
10. The peripheral's SDK handles transaction data received from the Nayax Device via Transfer Data (said data includes information about the Nayax transaction ID and the consumer's card details):
    ```c
    vmc_vend_event_handler_cb(vm_vend_event_on_transaction_info)
    ```
    ```csharp
    vend_callbacks(onTransactionInfo(data))
    ```
    ```java
    vmc_vend_events()
    (via onTransactionInfo(data))
    ```
11. The SDK triggers "Vend Approved" events:
    ```c
    vmc_vend_event_handler_cb(vm_vend_event_on_vend_approved)
    ```
    ```csharp
    vend_callbacks()
    (via onVendApproved(session))
    ```
    ```java
    vmc_vend_events()
    (via onVendApproved(session))
    ```
12. The peripheral starts dispensing the product/ providing the service to the consumer.
13. The SDK reports "vend success":
    ```c
    vmc_vend_vend_status(&session, __true)
    ```
    ```csharp
    vmc_vend_events()
    (via onVendApproved(session) -which would return "true")
    ```
    ```java
    vmc_vend_events()
    (via onVendApproved(session) -which would return "true")
    ```
    and completes the vend session:
    ```c
    vmc_vend_vend_session_complete_lowlevel()
    ```
    ```csharp
    no such function in C# or Java due to the nature of the languages
    ```
    ```java
    no such function in C# or Java due to the nature of the languages
    ```
    <br />
14. The first part of the transaction **ends**.

<Image border={false} src="https://files.readme.io/521cbf2b8c589ab99a86140f9b74ea8ff2409d4b24ce705fb4cca433622f857b-image.png" />

15. The machine finishes dispensing the product / providing the service.
16. Vending machine SDK settles the transaction (session):
    ```c
    vmc_vend_session_close(session)
    ```
    ```csharp
    vmc_instance.vend.session_close(session)
    ```
    ```java
    m_vmc.vend.session_close(session)
    ```
17. The Nayax Server forwards the settlement request to the Billing Provider.
18. The billing Provider sends a settlement response (OK) to the Nayax Server.
19. Nayax Server returns the settlement response (OK) to the Nayax Device.
20. The peripheral's SDK receives a status command regarding the settlement (whether the device was able to settle it or not) and triggers a "settlement" event:
    ```c
    vmc_vend_event_handler_cb(vm_vend_event_on_settlement)
    ```
    ```csharp
    vmc_vend_events()
    (via onSettlement(success) -which would return "true")
    ```
    ```java
    vmc_vend_events()
    (via onSettlement(success) -which would return "true")
    ```
21. Vending machine SDK transfers data and triggers a "transaction info" event:
    ```c
    vmc_vend_event_handler_cb(vm_vend_event_on_transaction_info)
    ```
    ```csharp
    vmc_vend_events()
    (via onTransactionInfo(data))
    ```
    ```java
    vmc_vend_events()
    (via onTransactionInfo(data))
    ```
22. Message to the consumer: "Thank you & Goodbye."

## See also

<HTMLBlock>{`
<style>
  @import url('https://fonts.googleapis.com/css2?family=Inter:wght@100..900&display=swap');

  .card_container {
    display: flex;
    gap: 10px;
    margin: 0 auto;
    max-width: var(--container-lg);
    width: 100%;
    flex-wrap: wrap;

    .card {
      display: flex;
      padding: 20px 14px;
      flex-direction: column;
      justify-content: center;
      align-items: flex-start;
      min-width: 190px;
      flex-shrink: 0;
      gap: 12px;
      border-radius: 6px;
      border: 1px solid #DCDCDC;
      background: #FFF;
      box-shadow: 0px 3.656px 27.422px 0px rgba(0, 0, 0, 0.13);
      text-decoration: none;
      flex-grow: 1;
      flex-basis: 0;
      text-decoration: none !important;

      svg {
        fill: none;

        rect {
          fill: #FFF;
          stroke: #C9C9C9;
        }

        path {
          fill: #d2a900;
        }
      }

      h3 {
        color: #383838;
        text-align: center;
        font-family: Inter !important;
        font-size: 17.5px;
        font-style: normal;
        font-weight: 700;
        text-decoration: none;
        margin: 0;
        text-align: start;
      }
    }

    .card:hover {
      cursor: pointer;
      border: 1px solid #d2a900 !important;
      box-shadow: 0px 4px 30px 0px rgba(0, 0, 0, 0.13);
      transform: translateY(-1px);

      svg {
        fill: none;

        rect {
          fill: #d2a900;
          stroke: #C9C9C9;
        }

        path {
          fill: #FFF;
        }
      }
    }
  }

  @media (prefers-color-scheme: dark) {
    [data-color-mode="system"] .card_container {
      .card {
        border: 1px solid #556974;
        background: #20292e;

        svg {
          rect {
            fill: #20292e;
            stroke: #556974;
          }
        }

        h3,
        p {
          color: #FFF;
        }
      }

      .card:hover {
        cursor: pointer;
        border: 1px solid #d2a900 !important;
        box-shadow: 0px 4px 30px 0px rgba(0, 0, 0, 0.13);
        transform: translateY(-1px);

        h3 {
          color: #d2a900;
        }

        svg {
          fill: none;

          rect {
            fill: #d2a900;
            stroke: #556974;
          }

          path {
            fill: #20292e;
          }
        }
      }
    }
  }

  [data-color-mode="dark"] .card_container {
    .card {
      border: 1px solid #556974;
      background: #20292e;

      svg {
        rect {
          fill: #20292e;
          stroke: #556974;
        }
      }

      h3,
      p {
        color: #FFF;
      }
    }

    .card:hover {
      cursor: pointer;
      border: 1px solid #d2a900 !important;
      box-shadow: 0px 4px 30px 0px rgba(0, 0, 0, 0.13);
      transform: translateY(-1px);

      h3 {
        color: #d2a900;
      }

      svg {
        fill: none;

        rect {
          fill: #d2a900;
          stroke: #556974;
        }

        path {
          fill: #20292e;
        }
      }
    }
  }

  @media only screen and (max-width: 450px) {
    .card_container {
      grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
    }
  }
</style>

<div class="card_container">

  <a class="card" href="/v1.0/docs/marshall-payment-flows">
    <svg xmlns="http://www.w3.org/2000/svg" width="33" height="33" viewBox="0 0 33 33">
      <rect x="0.5" y="0.5" width="31.8205" height="31.8205" rx="3.70776" />
      <path fill-rule="evenodd" clip-rule="evenodd"
        d="M23.3736 24.9994C22.4754 24.9994 21.7472 24.2712 21.7472 23.373V11.2526L9.62638 11.2526C8.72816 11.2526 8 10.5245 8 9.62632C8 8.72813 8.72816 8 9.62639 8L23.3736 8C24.2718 8 25 8.72813 25 9.62632L25 23.373C25 24.2712 24.2718 24.9994 23.3736 24.9994Z" />
      <path fill-rule="evenodd" clip-rule="evenodd"
        d="M22.8056 10.1953C23.4408 10.8304 23.4408 11.8602 22.8056 12.4953L10.7768 24.5237C10.1416 25.1588 9.11188 25.1588 8.47674 24.5237C7.84159 23.8885 7.84159 22.8588 8.47673 22.2237L20.5056 10.1953C21.1407 9.56019 22.1705 9.56019 22.8056 10.1953Z" />
    </svg>
    <h3>Payment Flows</h3>
  </a>

  <a class="card" href="/v1.0/docs/marshall-get-started">
    <svg xmlns="http://www.w3.org/2000/svg" width="33" height="33" viewBox="0 0 33 33">
      <rect x="0.5" y="0.5" width="31.8205" height="31.8205" rx="3.70776" />
      <path fill-rule="evenodd" clip-rule="evenodd"
        d="M23.3736 24.9994C22.4754 24.9994 21.7472 24.2712 21.7472 23.373V11.2526L9.62638 11.2526C8.72816 11.2526 8 10.5245 8 9.62632C8 8.72813 8.72816 8 9.62639 8L23.3736 8C24.2718 8 25 8.72813 25 9.62632L25 23.373C25 24.2712 24.2718 24.9994 23.3736 24.9994Z" />
      <path fill-rule="evenodd" clip-rule="evenodd"
        d="M22.8056 10.1953C23.4408 10.8304 23.4408 11.8602 22.8056 12.4953L10.7768 24.5237C10.1416 25.1588 9.11188 25.1588 8.47674 24.5237C7.84159 23.8885 7.84159 22.8588 8.47673 22.2237L20.5056 10.1953C21.1407 9.56019 22.1705 9.56019 22.8056 10.1953Z" />
    </svg>
    <h3>Get Started</h3>
  </a>

  <a class="card" href="/v1.0/docs/marshall-methods-and-functions">
    <svg xmlns="http://www.w3.org/2000/svg" width="33" height="33" viewBox="0 0 33 33">
      <rect x="0.5" y="0.5" width="31.8205" height="31.8205" rx="3.70776" />
      <path fill-rule="evenodd" clip-rule="evenodd"
        d="M23.3736 24.9994C22.4754 24.9994 21.7472 24.2712 21.7472 23.373V11.2526L9.62638 11.2526C8.72816 11.2526 8 10.5245 8 9.62632C8 8.72813 8.72816 8 9.62639 8L23.3736 8C24.2718 8 25 8.72813 25 9.62632L25 23.373C25 24.2712 24.2718 24.9994 23.3736 24.9994Z" />
      <path fill-rule="evenodd" clip-rule="evenodd"
        d="M22.8056 10.1953C23.4408 10.8304 23.4408 11.8602 22.8056 12.4953L10.7768 24.5237C10.1416 25.1588 9.11188 25.1588 8.47674 24.5237C7.84159 23.8885 7.84159 22.8588 8.47673 22.2237L20.5056 10.1953C21.1407 9.56019 22.1705 9.56019 22.8056 10.1953Z" />
    </svg>
    <h3>Methods & Functions</h3>
  </a>

</div>
`}</HTMLBlock>



<br />